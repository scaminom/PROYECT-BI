<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Predictor de Temporada de Productos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  </head>

  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">
        Predictor de Temporada de Productos
      </h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Formulario -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-semibold mb-4">Datos del Producto</h2>
          <form id="predictionForm" class="space-y-4">
            <!-- Categoría de Producto -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Categoría de Producto</label
              >
              <select
                name="product_category"
                id="product_category"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                <option value="">Seleccione una categoría</option>
                {% for category in categories.product_categorys %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Subcategoría -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Subcategoría</label
              >
              <select
                name="subcategory"
                id="subcategory"
                required
                disabled
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                <option value="">Seleccione primero una categoría</option>
              </select>
            </div>

            <!-- Categoría de Material -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Categoría de Material</label
              >
              <select
                name="material_category"
                id="material_category"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                <option value="">Seleccione una categoría</option>
                {% for category in categories.material_categorys %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Tipo de Material -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Tipo de Material</label
              >
              <select
                name="material_type"
                id="material_type"
                required
                disabled
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                <option value="">
                  Seleccione primero una categoría de material
                </option>
              </select>
            </div>

            <!-- Grosor -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Grosor</label
              >
              <select
                name="thickness"
                id="thickness"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                {% for thickness in categories.thicknesss %}
                <option value="{{ thickness }}">{{ thickness }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Impermeabilidad -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Impermeabilidad</label
              >
              <select
                name="waterproof_rating"
                id="waterproof_rating"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                {% for rating in categories.waterproof_ratings %}
                <option value="{{ rating }}">{{ rating }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Rating Térmico -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Rating Térmico</label
              >
              <select
                name="thermal_rating"
                id="thermal_rating"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                {% for rating in categories.thermal_ratings %}
                <option value="{{ rating }}">{{ rating }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Color -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Color</label
              >
              <select
                name="color_family"
                id="color_family"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                {% for color in categories.color_familys %}
                <option value="{{ color }}">{{ color }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Patrón -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Patrón</label
              >
              <select
                name="pattern"
                id="pattern"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                {% for pattern in categories.patterns %}
                <option value="{{ pattern }}">{{ pattern }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Estilo -->
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Estilo</label
              >
              <select
                name="style"
                id="style"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
              >
                {% for style in categories.styles %}
                <option value="{{ style }}">{{ style }}</option>
                {% endfor %}
              </select>
            </div>

            <button
              type="submit"
              class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            >
              Predecir Temporada
            </button>
          </form>
        </div>

        <!-- Resultados -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-semibold mb-4">
            Resultados de la Predicción
          </h2>
          <div class="relative" style="height: 300px">
            <canvas id="resultsChart"></canvas>
          </div>
          <div id="predictions" class="mt-4 space-y-2">
            <!-- Los resultados se mostrarán aquí -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let chart = null;

      // Función para actualizar select con nuevas opciones
      function updateSelect(
        selectElement,
        options,
        defaultText = "Seleccione una opción"
      ) {
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        options.forEach((option) => {
          const optionElement = document.createElement("option");
          optionElement.value = option;
          optionElement.textContent = option;
          selectElement.appendChild(optionElement);
        });
        selectElement.disabled = false;
      }

      // Event listener para categoría de producto
      document
        .getElementById("product_category")
        .addEventListener("change", async function () {
          const category = this.value;
          const subcategorySelect = document.getElementById("subcategory");

          if (category) {
            try {
              const response = await fetch(`/get_subcategories/${category}`);
              const data = await response.json();

              if (data.success) {
                updateSelect(
                  subcategorySelect,
                  data.subcategories,
                  "Seleccione una subcategoría"
                );
              } else {
                console.error("Error:", data.error);
                subcategorySelect.innerHTML =
                  '<option value="">Error al cargar subcategorías</option>';
                subcategorySelect.disabled = true;
              }
            } catch (error) {
              console.error("Error:", error);
              subcategorySelect.innerHTML =
                '<option value="">Error de conexión</option>';
              subcategorySelect.disabled = true;
            }
          } else {
            subcategorySelect.innerHTML =
              '<option value="">Seleccione primero una categoría</option>';
            subcategorySelect.disabled = true;
          }
        });

      // Event listener para categoría de material
      document
        .getElementById("material_category")
        .addEventListener("change", async function () {
          const category = this.value;
          const materialTypeSelect = document.getElementById("material_type");

          if (category) {
            try {
              const response = await fetch(`/get_material_types/${category}`);
              const data = await response.json();

              if (data.success) {
                updateSelect(
                  materialTypeSelect,
                  data.material_types,
                  "Seleccione un tipo de material"
                );
              } else {
                console.error("Error:", data.error);
                materialTypeSelect.innerHTML =
                  '<option value="">Error al cargar tipos de material</option>';
                materialTypeSelect.disabled = true;
              }
            } catch (error) {
              console.error("Error:", error);
              materialTypeSelect.innerHTML =
                '<option value="">Error de conexión</option>';
              materialTypeSelect.disabled = true;
            }
          } else {
            materialTypeSelect.innerHTML =
              '<option value="">Seleccione primero una categoría de material</option>';
            materialTypeSelect.disabled = true;
          }
        });

      // Event listener para el formulario
      document
        .getElementById("predictionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);

          try {
            const response = await fetch("/predict", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
              displayResults(result.predictions, result.recommended_season);
            } else {
              alert("Error: " + result.error);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error de conexión. Por favor, intente nuevamente.");
          }
        });

      // Función para mostrar resultados
      function displayResults(predictions, recommendedSeason) {
        if (chart) {
          chart.destroy();
        }

        const ctx = document.getElementById("resultsChart").getContext("2d");
        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: Object.keys(predictions),
            datasets: [
              {
                label: "Probabilidad (%)",
                data: Object.values(predictions),
                backgroundColor: [
                  "rgba(75, 192, 192, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(255, 206, 86, 0.6)",
                  "rgba(255, 99, 132, 0.6)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: "Probabilidad (%)",
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
              title: {
                display: true,
                text: "Probabilidades de Temporada",
              },
            },
          },
        });

        const predictionsDiv = document.getElementById("predictions");
        predictionsDiv.innerHTML = `
          <div class="mb-4 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-2">Resumen de la Predicción</h3>
            <p class="text-gray-700">
              La temporada más probable es <span class="font-bold text-indigo-600">${recommendedSeason}</span>
              con una probabilidad del <span class="font-bold text-indigo-600">${predictions[
                recommendedSeason
              ].toFixed(1)}%</span>
            </p>
          </div>
          ${Object.entries(predictions)
            .map(
              ([season, probability]) => `
              <div class="flex justify-between items-center p-2 ${
                season === recommendedSeason ? "bg-green-100 rounded" : ""
              }">
                <span class="font-medium">${season}</span>
                <div class="flex items-center">
                  <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                    <div class="bg-indigo-600 h-2 rounded-full" style="width: ${probability}%"></div>
                  </div>
                  <span class="text-lg font-semibold">${probability.toFixed(
                    1
                  )}%</span>
                </div>
              </div>
            `
            )
            .join("")}
        `;

        // Actualizar sugerencia de estilo si es necesario
        updateStyleSuggestions(recommendedSeason);
      }

      // Función para actualizar sugerencias de estilo
      async function updateStyleSuggestions(season) {
        try {
          const response = await fetch(`/get_styles/${season}`);
          const data = await response.json();

          if (data.success) {
            const styleSelect = document.getElementById("style");
            const currentStyle = styleSelect.value;

            if (currentStyle && data.styles[currentStyle]) {
              return;
            }

            // Sugerir el estilo más apropiado para la temporada
            const suggestedStyle = Object.entries(data.styles).sort(
              (a, b) => b[1] - a[1]
            )[0][0];

            styleSelect.value = suggestedStyle;
          }
        } catch (error) {
          console.error("Error al actualizar estilos:", error);
        }
      }

      // Event listeners para validaciones en tiempo real
      document
        .getElementById("thickness")
        .addEventListener("change", function () {
          const thermalRating = document.getElementById("thermal_rating").value;
          const productCategory =
            document.getElementById("product_category").value;

          if (
            this.value === "Ligero" &&
            thermalRating === "Muy Alto" &&
            productCategory === "Outerwear"
          ) {
            alert(
              "Advertencia: Una prenda exterior ligera con rating térmico muy alto podría no ser apropiada"
            );
          }
        });

      document
        .getElementById("thermal_rating")
        .addEventListener("change", function () {
          const thickness = document.getElementById("thickness").value;
          const productCategory =
            document.getElementById("product_category").value;

          if (
            this.value === "Muy Alto" &&
            thickness === "Ligero" &&
            productCategory === "Outerwear"
          ) {
            alert(
              "Advertencia: Un rating térmico muy alto en una prenda ligera podría no ser apropiado"
            );
          }
        });

      // Inicialización del formulario
      document.addEventListener("DOMContentLoaded", function () {
        // Desactivar selects dependientes al inicio
        document.getElementById("subcategory").disabled = true;
        document.getElementById("material_type").disabled = true;

        // Agregar clases de Tailwind a todos los selects
        document.querySelectorAll("select").forEach((select) => {
          select.classList.add(
            "form-select",
            "border",
            "rounded-md",
            "w-full",
            "p-2"
          );
        });
      });
    </script>
  </body>
</html>
